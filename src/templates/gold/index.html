{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Gold Investment Dashboard</h1>
    </div>
</div>

<!-- Current 24K Prices with Returns -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Current 24K Gold Prices</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Local Market</h6>
                        <table class="table table-bordered" id="localPriceTable">
                            <thead>
                                <tr>
                                    <th>Price (EGP/g)</th>
                                    <th>1D</th>
                                    <th>5D</th>
                                    <th>1M</th>
                                    <th>1Y</th>
                                    <th>5Y</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="local_24k_price">-</td>
                                    <td id="local_1d_return">-</td>
                                    <td id="local_5d_return">-</td>
                                    <td id="local_1m_return">-</td>
                                    <td id="local_1y_return">-</td>
                                    <td id="local_5y_return">-</td>
                                </tr>
                            </tbody>
                        </table>
                        <small id="localPriceDate" class="text-muted">-</small>
                    </div>
                    <div class="col-md-6">
                        <h6>Global Market</h6>
                        <table class="table table-bordered" id="globalPriceTable">
                            <thead>
                                <tr>
                                    <th>Price (EGP/g)</th>
                                    <th>1D</th>
                                    <th>5D</th>
                                    <th>1M</th>
                                    <th>1Y</th>
                                    <th>5Y</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="global_24k_price">-</td>
                                    <td id="global_1d_return">-</td>
                                    <td id="global_5d_return">-</td>
                                    <td id="global_1m_return">-</td>
                                    <td id="global_1y_return">-</td>
                                    <td id="global_5y_return">-</td>
                                </tr>
                            </tbody>
                        </table>
                        <small id="globalPriceDate" class="text-muted">-</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All-Time High and Low Prices -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">All-Time 24K Price Extremes</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Local Market</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Price (EGP/g)</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>All-Time High</td>
                                    <td id="local_max_price">-</td>
                                    <td id="local_max_date">-</td>
                                </tr>
                                <tr>
                                    <td>All-Time Low</td>
                                    <td id="local_min_price">-</td>
                                    <td id="local_min_date">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Global Market</h6>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Price (EGP/g)</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>All-Time High</td>
                                    <td id="global_max_price">-</td>
                                    <td id="global_max_date">-</td>
                                </tr>
                                <tr>
                                    <td>All-Time Low</td>
                                    <td id="global_min_price">-</td>
                                    <td id="global_min_date">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Investment Summary -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Investment Summary</h5>
                <div>
                    <a href="{{ url_for('gold.add_price') }}" class="btn btn-primary btn-sm me-2">Add Gold Price</a>
                    <a href="{{ url_for('gold.transaction_form', type='buy') }}" class="btn btn-primary btn-sm me-2">Add Buy</a>
                    <a href="{{ url_for('gold.transaction_form', type='sell') }}" class="btn btn-primary btn-sm me-2">Add Sell</a>
                    <a href="{{ url_for('gold.import_prices') }}" class="btn btn-primary btn-sm">Import Prices</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5>Total Investment</h5>
                                <p class="dashboard-stat" style="font-size: 1.5rem;" id="totalInvestment">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5>Current Value</h5>
                                <p class="dashboard-stat" style="font-size: 1.5rem;" id="currentValue">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5>Return</h5>
                                <p class="dashboard-stat" style="font-size: 1.5rem;" id="returnAmount">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5>Return %</h5>
                                <p class="dashboard-stat" style="font-size: 1.5rem;" id="returnPercentage">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Holdings -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Current Holdings</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover" id="holdingsTable">
                    <thead>
                        <tr>
                            <th>Karat</th>
                            <th>Weight (g)</th>
                            <th>Avg Purchase Price (EGP/g)</th>
                            <th>Current Price (EGP/g)</th>
                            <th>Current Value (EGP)</th>
                            <th>Return (EGP)</th>
                            <th>Return %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Gold Holdings Distribution</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="goldHoldingsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sale Calculator -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Sale Calculator</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="gramsToSell" class="form-label">Grams to Sell</label>
                        <input type="number" class="form-control" id="gramsToSell" name="gramsToSell" min="0.01" step="0.01" value="8">
                    </div>
                    <div class="col-md-4">
                        <label for="karatToSell" class="form-label">Karat</label>
                        <select class="form-control" id="karatToSell" name="karat_sold">
                            <option value="24">24K</option>
                            <option value="21" selected>21K</option>
                            <option value="18">18K</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" id="calculateSale" class="btn btn-primary">Calculate</button>
                    </div>
                </div>
                <div id="saleResults" class="mt-3" style="display:none;">
                    <h6>Sale Results</h6>
                    <p>Sell Value: <span id="sellValue">-</span></p>
                    <p>Return: <span id="saleReturn">-</span> (<span id="saleReturnPercentage">-</span>)</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Transactions</h5>
                <a href="{{ url_for('gold.all_transactions') }}" class="btn btn-primary btn-sm">View All Transactions</a>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover" id="recentTransactionsTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Weight (g)</th>
                            <th>Karat</th>
                            <th>Price/g</th>
                            <th>Total</th>
                            <th>Return</th>
                            <th>Return %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Daily Returns Chart -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Daily Returns</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="dailyReturnsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script>
    let goldHoldingsChart, dailyReturnsChart;
    const csrfToken = "{{ csrf_token() }}";

    function formatCurrency(value) {
        return `EGP ${Number(value || 0).toFixed(2)}`;
    }

    function formatPercentage(value) {
        const formatted = `${Number(value || 0).toFixed(2)}%`;
        return value > 0 ? `<span style="color: green;">${formatted} <i class="bi bi-arrow-up"></i></span>` :
               value < 0 ? `<span style="color: red;">${formatted} <i class="bi bi-arrow-down"></i></span>` : formatted;
    }

    function loadData(queryString = '') {
        // Current 24K Prices and Returns
        fetch('/gold/api/price-returns')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                // Local Market
                $('#local_24k_price').text(formatCurrency(data.local.current_price));
                $('#local_1d_return').html(formatPercentage(data.local.returns['1d']));
                $('#local_5d_return').html(formatPercentage(data.local.returns['5d']));
                $('#local_1m_return').html(formatPercentage(data.local.returns['1m']));
                $('#local_1y_return').html(formatPercentage(data.local.returns['1y']));
                $('#local_5y_return').html(formatPercentage(data.local.returns['5y']));
                $('#localPriceDate').text(`Last updated: ${data.local.date || 'Never'}`);
                $('#local_max_price').text(formatCurrency(data.local.all_time_max.price));
                $('#local_max_date').text(data.local.all_time_max.date || '-');
                $('#local_min_price').text(formatCurrency(data.local.all_time_min.price));
                $('#local_min_date').text(data.local.all_time_min.date || '-');

                // Global Market
                $('#global_24k_price').text(formatCurrency(data.global.current_price));
                $('#global_1d_return').html(formatPercentage(data.global.returns['1d']));
                $('#global_5d_return').html(formatPercentage(data.global.returns['5d']));
                $('#global_1m_return').html(formatPercentage(data.global.returns['1m']));
                $('#global_1y_return').html(formatPercentage(data.global.returns['1y']));
                $('#global_5y_return').html(formatPercentage(data.global.returns['5y']));
                $('#globalPriceDate').text(`Last updated: ${data.global.date || 'Never'}`);
                $('#global_max_price').text(formatCurrency(data.global.all_time_max.price));
                $('#global_max_date').text(data.global.all_time_max.date || '-');
                $('#global_min_price').text(formatCurrency(data.global.all_time_min.price));
                $('#global_min_date').text(data.global.all_time_min.date || '-');
            })
            .catch(error => console.error('Error fetching price returns:', error));

        // Investment Summary
        fetch(`/gold/api/investment-summary?${queryString}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                $('#totalInvestment').text(formatCurrency(data.total_investment));
                $('#currentValue').text(formatCurrency(data.current_value));
                $('#returnAmount').text(formatCurrency(data.return.amount));
                $('#returnPercentage').html(formatPercentage(data.return.percentage));

                if (goldHoldingsChart) goldHoldingsChart.destroy();
                goldHoldingsChart = new Chart(document.getElementById('goldHoldingsChart'), {
                    type: 'pie',
                    data: {
                        labels: ['24K', '21K', '18K'],
                        datasets: [{
                            data: [data.total_weight['24'] || 0, data.total_weight['21'] || 0, data.total_weight['18'] || 0],
                            backgroundColor: ['#FFD700', '#DAA520', '#B8860B'],
                            borderColor: '#fff',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            })
            .catch(error => console.error('Error fetching investment summary:', error));

        // Current Holdings Table
        $('#holdingsTable').DataTable({
            order: [[0, 'desc']],
            destroy: true,
            ajax: {
                url: `/gold/api/holdings?${queryString}`,
                dataSrc: ''
            },
            columns: [
                { data: 'karat', render: d => `${d}K` },
                { data: 'weight', render: d => d.toFixed(2) },
                { data: 'avg_purchase_price', render: d => formatCurrency(d) },
                { data: 'current_price', render: d => formatCurrency(d) },
                { data: 'current_value', render: d => formatCurrency(d) },
                { data: 'return', render: d => formatCurrency(d) },
                { data: 'return_percentage', render: d => formatPercentage(d) }
            ],
            searching: false,
            paging: false,
            info: false
        });

        // Sale Calculator
        $('#calculateSale').click(function(e) {
            e.preventDefault();
            const grams = $('#gramsToSell').val();
            const karat = $('#karatToSell').val();
            fetch(`/gold/api/investment-summary?grams_sold=${grams}&karat_sold=${karat}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.sale_metrics) {
                        $('#sellValue').text(formatCurrency(data.sale_metrics.sell_value));
                        $('#saleReturn').text(formatCurrency(data.sale_metrics.sale_return.amount));
                        $('#saleReturnPercentage').text(formatPercentage(data.sale_metrics.sale_return.percentage));
                        $('#saleResults').css('display', 'block');
                    }
                })
                .catch(error => console.error('Error calculating sale:', error));
        });

        // Recent Transactions
        $('#recentTransactionsTable').DataTable({
            order: [[1, 'desc']],
            destroy: true,
            ajax: {
                url: `/gold/api/transactions_all?limit=5`,
                dataSrc: ''
            },
            columns: [
                { data: 'type' },
                {
                    data: 'date',
                    render: function(data, type, row) {
                        return `<a href="/gold/transactions/details/${row.id}/${row.type.toLowerCase()}">${data}</a>`;
                    }
                },
                { data: 'weight', render: d => d.toFixed(2) },
                { data: 'karat', render: d => `${d}K` },
                { data: 'price', render: d => formatCurrency(d) },
                { data: 'total', render: d => formatCurrency(d) },
                {
                    data: 'return',
                    render: function(data, type, row) {
                        return row.type === 'Sell' ? formatCurrency(data) : '-';
                    }
                },
                {
                    data: 'return',
                    render: function(data, type, row) {
                        return row.type === 'Sell' ? formatPercentage((data / (row.weight * row.price)) * 100) : '-';
                    }
                }
            ],
            pageLength: 5
        });

        // Daily Returns Chart
        fetch(`/gold/api/daily-returns?${queryString}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (dailyReturnsChart) dailyReturnsChart.destroy();
                dailyReturnsChart = new Chart(document.getElementById('dailyReturnsChart'), {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Daily Returns (%)',
                            data: data.returns,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            y: { title: { display: true, text: 'Return (%)' } }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching daily returns:', error));
    }

    $(document).ready(function() {
        window.loadData = loadData; // Expose loadData globally
        loadData(); // Initial load

        // Initialize DataTables for price tables
        $('#localPriceTable').DataTable({ searching: false, paging: false, info: false });
        $('#globalPriceTable').DataTable({ searching: false, paging: false, info: false });
    });
</script>
{% endblock %}